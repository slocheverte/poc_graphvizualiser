<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersecurity Graph Analyzer - Client POC</title>
    <link rel="stylesheet" href="style.css">
    <!-- Early interceptor to block any legacy requests to /files before main scripts load -->
    <script>
        (function(){
            try {
                const origFetch = window.fetch;
                window.fetch = function(input, init){
                    try {
                        const url = (typeof input === 'string') ? input : (input && input.url);
                        if (url && url.indexOf('/files') !== -1) {
                            console.warn('[early-debug] Blocked fetch to /files ->', url);
                            console.trace();
                            return Promise.resolve(new Response(JSON.stringify({detail: 'blocked by client early interceptor'}), {status:404, headers: {'Content-Type':'application/json'}}));
                        }
                    } catch (e) { console.error('early fetch interceptor error', e); }
                    return origFetch.apply(this, arguments);
                };

                const origXOpen = XMLHttpRequest.prototype.open;
                const origXSend = XMLHttpRequest.prototype.send;
                XMLHttpRequest.prototype.open = function(method, url){
                    this.__openedUrl = url;
                    return origXOpen.apply(this, arguments);
                };
                XMLHttpRequest.prototype.send = function(body){
                    try {
                        if (this.__openedUrl && String(this.__openedUrl).indexOf('/files') !== -1) {
                            console.warn('[early-debug] Blocked XHR to /files ->', this.__openedUrl);
                            console.trace();
                            const self = this;
                            setTimeout(() => {
                                try { self.readyState = 4; self.status = 404; } catch(e){}
                                if (typeof self.onreadystatechange === 'function') try{ self.onreadystatechange(); }catch(e){}
                                if (typeof self.onload === 'function') try{ self.onload(); }catch(e){}
                            }, 0);
                            return;
                        }
                    } catch(e){ console.error('early XHR interceptor error', e); }
                    return origXSend.apply(this, arguments);
                };
            } catch (e) {
                console.error('Error installing early /files interceptor', e);
            }
        })();
    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ÔøΩ Cybersecurity Graph Analyzer</h1>
            <p>Client POC pour visualiser les analyses de graphe de s√©curit√©</p>
        </header>

        <!-- Barre de statut -->
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="label">Status:</span>
                <span id="analysisStatus" class="badge">-</span>
            </div>
            <div class="status-item">
                <span class="label">Threat Level:</span>
                <span id="threatLevel" class="badge">-</span>
            </div>
            <div class="status-item">
                <span class="label">Confidence:</span>
                <span id="confidenceLevel" class="badge">-</span>
            </div>
            <div class="status-item">
                <span class="label">Records:</span>
                <span id="recordCount">0</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="upstreamInput">üîó Upstream API:</label>
                <input type="text" id="upstreamInput" placeholder="http://127.0.0.1:8000">
                <button onclick="setUpstream()" class="btn btn-primary">Configurer</button>
                <span id="upstreamStatus" style="margin-left:10px;color:#95a5a6;">(non configur√©)</span>
            </div>
            <div class="control-group">
                <!-- Liste d√©roulante supprim√©e : l'application utilise maintenant l'upstream et la saisie de question -->
            </div>

            <div class="control-group">
                <label for="questionInput">‚ùì Question (analyze):</label>
                <input type="text" id="questionInput" placeholder="Ex: What are Internet-Exposed Devices?">
                <button onclick="analyzeQuestion()" class="btn btn-success">Analyser</button>
            </div>
        </div>

        <div class="main-content">
            <div class="panel graph-panel">
                <h3>üîç Graphe de s√©curit√©</h3>
                <div id="network"></div>
                <div class="graph-legend">
                    <div class="legend-item"><span class="legend-color" style="background: #ff6b6b;"></span> Critical</div>
                    <div class="legend-item"><span class="legend-color" style="background: #ee5a6f;"></span> High</div>
                    <div class="legend-item"><span class="legend-color" style="background: #feca57;"></span> Medium</div>
                    <div class="legend-item"><span class="legend-color" style="background: #48dbfb;"></span> Low</div>
                    <div class="legend-item"><span class="legend-color" style="background: #1dd1a1;"></span> Safe</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel summary-panel">
                    <h3>üìä R√©sum√©</h3>
                    <div id="summaryContent" class="content-box">
                        S√©lectionnez une analyse pour voir le r√©sum√©
                    </div>
                </div>

                <div class="panel recommendations-panel">
                    <h3>üí° Recommandations</h3>
                    <div id="recommendationsContent" class="content-box">
                        Aucune recommandation
                    </div>
                </div>
            </div>
        </div>

        <div class="details-section">
            <div class="panel">
                <h3>üî¨ Analyse technique</h3>
                <div id="technicalAnalysis" class="content-box">
                    Aucune analyse charg√©e
                </div>
            </div>

            <div class="panel">
                <h3>üìã D√©tails du n≈ìud s√©lectionn√©</h3>
                <div id="nodeDetails" class="content-box">
                    Cliquez sur un n≈ìud pour voir ses d√©tails
                </div>
            </div>
        </div>

        <div class="panel json-panel">
            <h3>üìÑ Donn√©es JSON brutes</h3>
            <button onclick="toggleJsonView()" class="btn btn-secondary btn-sm">Afficher/Masquer</button>
            <pre id="jsonDisplay" style="display: none;"></pre>
        </div>
    </div>

    <script src="script.js?v=3"></script>
</body>
</html>
